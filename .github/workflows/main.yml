on:
  push:
    branches:
      - master
name: ðŸš€ Deploy website on push

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest

    steps:
    - name: ðŸšš Get latest code
      uses: actions/checkout@v3
    
    - name: ðŸ“‚ Sync files
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server:   ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
    
    - name: ðŸ“‚ Generate new index.fcgi name
      id: generate_name
      run: echo "::set-output name=filename::index_$(date +%s).fcgi"
    
    - name: Rename index.fcgi and update .htaccess via SSH
      env:
        SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        SSH_SERVER: ${{ secrets.SSH_SERVER }}
      run: |
        NEW_NAME=${{ steps.generate_name.outputs.filename }}
        echo "Renaming index.fcgi to $NEW_NAME on server"
        sshpass -p $SSH_PASSWORD ssh $SSH_USERNAME@$SSH_SERVER "mv /home2/hg0x6a20/infectz.0x6a70.com/index.fcgi /home2/hg0x6a20/infectz.0x6a70.com/$NEW_NAME"
        echo "Updating .htaccess to point to $NEW_NAME"
        sshpass -p $SSH_PASSWORD ssh $SSH_USERNAME@$SSH_SERVER "sed -i 's|RewriteRule \^(.*)$ index.*.fcgi/\$1 \[QSA,L\]|RewriteRule ^(.*)$ $NEW_NAME/\$1 [QSA,L]|' /home2/hg0x6a20/infectz.0x6a70.com/.htaccess"
