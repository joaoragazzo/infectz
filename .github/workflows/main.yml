on:
  push:
    branches:
      - master
name: ðŸš€ Deploy website on push

jobs:
  web-deploy:
    name: ðŸŽ‰ Deploy
    runs-on: ubuntu-latest

    steps:
    - name: ðŸšš Get latest code
      uses: actions/checkout@v3

    - name: Install sshpass
      run: sudo apt-get install sshpass

    - name: ðŸ“‚ Sync files
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}

    - name: Generate new index.fcgi name
      id: generate_name
      run: echo "filename=index_$(date +%s).fcgi" >> $GITHUB_ENV

    - name: Rename index.fcgi and update .htaccess via SSH
      env:
        SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
        SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        SSH_SERVER: ${{ secrets.SSH_SERVER }}
        NEW_NAME: ${{ env.filename }}
      run: |
        echo "Renaming index.fcgi to $NEW_NAME on server"
        sshpass -p $SSH_PASSWORD ssh -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_SERVER "mv /path/to/your/web/root/index.fcgi /path/to/your/web/root/$NEW_NAME"
        if [ $? -ne 0 ]; then exit 1; fi
        echo "Updating .htaccess to point to $NEW_NAME"
        sshpass -p $SSH_PASSWORD ssh -o StrictHostKeyChecking=no $SSH_USERNAME@$SSH_SERVER "sed -i 's|RewriteRule ^(.*)$ index.*.fcgi/\$1 [QSA,L]|RewriteRule ^(.*)$ $NEW_NAME/\$1 [QSA,L]|' /path/to/your/web/root/.htaccess"
        if [ $? -ne 0 ]; then exit 1; fi
