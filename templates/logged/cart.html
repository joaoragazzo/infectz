<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% include 'includes/servername.html' %}</title>
    {% include 'includes/default_links.html' %}
</head>
<body>

    {% include 'includes/header.html' %}


    <div class="container full justify-content-center text-center slogan big-text emph margin-top-medium">
        SEU CARRINHO
    </div>

    <div class="container d-flex justify-content-center align-items-end position-relative margin-top-low">
        <div class="cart text-center">
            <div class="cart-content scrollable-container">
                {% for cart_item in cart_items %}
                <div class="cart-item row p-10">
                    <div class="col-auto p-0 small-icon">
                        <div class="image-container">
                            <img src="{{ cart_item["image"] }}">
                        </div>
                    </div>
                    <div class="col-6 text-left flex-grow-1">
                        <div class="medium-text abel"><b>{{ cart_item["name"] }}</b></div>
                        <div class="small-text abel">R$ {{ cart_item["price"] }}</div>
                    </div>
                    <div class="col-2 flex-grow-1 center">
                        <div class="row flex-grow-1 abel">
                            <div class="col padding-right-none">
                                <button class="button-small" onclick="updateCart('{{ cart_item['id'] }}','add')">
                                    +
                                </button>
                            </div>
                            <div class="col">
                                <div id="item-count-{{ cart_item['id'] }}">
                                    {{ cart_item["count"] }}
                                </div>
                            </div>
                            <div class="col padding-left-none">
                                <button class="button-small" onclick="updateCart('{{ cart_item['id'] }}','remove')">
                                    -
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="row">
                <div class="col">
                    <button class="button-primary abel padding-tb-low">
                        Continuar comprando
                    </button>
                </div>
                <div class="col">
                    <button class="button-primary abel padding-tb-low">
                        Ir para o pagamento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="feedback"></div>

    <script>
        function updateCart(item_id, action) {
            const url = "{{ url_for('main.cart_add_item') }}";
            const data = new FormData();
            data.append('item_id', item_id);
            data.append('action', action);

            $.ajax({
                url: url,
                type: 'POST',
                data: data,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.status === 'success') {
                        const itemCountElem = $('#item-count-' + item_id);
                        let itemCount = parseInt(itemCountElem.text());

                        if (action === 'add') {
                            itemCount++;
                        } else if (action === 'remove') {
                            itemCount--;
                        }

                        if (itemCount <= 0) {
                            $('#cart-item-' + item_id).remove();
                        } else {
                            itemCountElem.text(itemCount);
                        }

                        showFeedback(response.message, response.status);
                    } else {
                        showFeedback(response.message, response.status);
                    }
                },
                error: function(xhr, status, error) {
                    console.log('Failed: ', error);
                    showFeedback('Falha ao atualizar o carrinho.', 'error');
                }
            });
        }

        function showFeedback(message, status) {
            const feedback = $('#feedback');
            feedback.text(message);
            feedback.removeClass('error-message success-message warning-message');
            if (status === 'error') {
                feedback.addClass('error-message');
            } else if (status === 'success') {
                feedback.addClass('success-message');
            } else if (status === 'warning') {
                feedback.addClass('warning-message');
            }
            feedback.show();
            setTimeout(() => {
                feedback.fadeOut();
            }, 3000);
        }

    </script>

    {% include 'includes/logged_scripts.html' %}
</body>
</html>